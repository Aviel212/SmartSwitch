<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="./styles/w3css.css" rel="stylesheet" />
    <script src="Scripts/jquery.js"></script>
    <script src="./Scripts/SmartSwitchServerInterface.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif&display=swap" rel="stylesheet">
    <style>
        /*#mainTable {
            margin: auto;
            border-collapse: collapse;
            margin-top: 20px;
        }
            #mainTable td {
                border: 1px solid black;
                padding: 5px;

            }*/

        img {
            width: 50px;
            height: 50px;
            
        }

        #circle {
            width: 20px;
            height: 20px;
            margin:auto;
        }

        button {
            margin: 10px;
        }

        .blur {
            text-shadow: 1px 1px 5px #aaa;
            color: transparent;
           
        }
            .blur img, .blur div, .blur input[type=checkbox] {
               opacity: 0.3;
            }
        body {
            font-family: 'Bree Serif', serif;
        }
        #plugs_tbl td, #plugs_tbl th {
            text-align: center;
            vertical-align: middle;
            padding: 8px 8px;
            /*display: table-cell;*/
            border-right:1px solid black;
        }
        
    </style>
</head>
<body>
    <h3>
        Plugs Manager
    </h3>

    <br />

    <div class="w3-bar" style="width:60%;margin-left:100px">
        <button onclick="refresh()" class="w3-bar-item w3-button w3-green w3-ripple" style="width:20%">Refresh</button>
        <button onclick="modifyMode()" class="w3-bar-item w3-button w3-teal w3-ripple" style="width:20%">Modify</button>
        <button onclick="getFocus()" class="w3-bar-item w3-button w3-red w3-ripple" style="width:20%">Remove</button>
        <button class="w3-bar-item w3-button w3-gray w3-ripple" style="width:20%" onclick="saveChanges()">Save</button>
    </div>

    <br />

    <div>
        <table id="plugs_tbl" class="w3-table-all w3-hoverable">
            <thead>
                <tr class="w3-gray">
                    <th>N.</th>
                    <th>icon</th>
                    <th>name</th>
                    <th>priority</th>
                    <th>approval</th>
                    <th>isWork</th>
                    <th>properties</th>
                </tr>
            </thead>
            <tbody>
                <!--<tr>
                    <td>1</td>
                    <td><img src="./resources/toaster.png" /></td>
                    <td>toaster</td>
                    <td>non-essential</td>
                    <td>
                        <input class="w3-check" type="checkbox" checked="checked" disabled>
                    </td>
                    <td><div id="circle" class="w3-circle w3-red"></div></td>
                    <td><a href="#">...</a></td>
                </tr>
                <tr>
                    <td>2</td>
                    <td><img src="./resources/tv.png" /></td>
                    <td>TV</td>
                    <td>non-essential</td>
                    <td>
                        <input class="w3-check" type="checkbox" unchecked="" disabled>
                    </td>
                    <td>
                        <div id="circle" class="w3-circle w3-green"></div>
                    </td>
                    <td>
                        <a href="#">...</a>
                    </td>
                </tr>
                <tr>
                    <td>2</td>
                    <td><img src="./resources/fridge.png" /></td>
                    <td>Fridge</td>
                    <td>essential</td>
                    <td>
                        <input class="w3-check" type="checkbox" checked="" disabled>
                    </td>
                    <td>
                        <div id="circle" class="w3-circle w3-green"></div>
                    </td>
                    <td>
                        <a href="#">...</a>
                    </td>
                </tr>-->
            </tbody>
        </table>
    </div>
    <!--<div>
        <input id="ch" class="w3-check" type="checkbox" checked="">
    </div>-->
    <script>
        var manipulatedPlugs = [];
        var plugs;
        var row;
        var $maniRow;
        var rowInChange = -1;
        var inChanging = false;
        var modify_enabled = false;

        var selectArr = [
            { val: 0, text: "ESSENTIAL" },
            { val: 1, text: "NONESSENTIAL" },
            { val: 2, text: "IRRELEVANT" }
        ];

        function updatePlug() {
            if (rowInChange == -1)
                return;
            //if (plugs[rowInChange - 1].Nickname === $maniRow.children("td").eq()
             //Priority Approved IsOn
        }

        function fadeRows() {
            $("tr:has(td)").hover(function (e) {
                $(this).css("cursor", "pointer");
                $("tr:has(td)").addClass('blur');
                $(this).removeClass('blur');
            },
                function (e) {
                    if (!modify_enabled)
                        $("tr:has(td)").removeClass('blur');
                });

            $("img").hover(function (e) {
                $(this).css("cursor", "pointer");
                $("img").addClass('blur');
                $(this).removeClass('blur');
            },
                function (e) {
                    if (!modify_enabled)
                        $("img").removeClass('blur');
                });
        }

        function init() {
            rowInChange = -1;
            inChanging = false;
            modify_enabled = false;
        }

        function modifyMode() {

            modify_enabled = true;
            $("tr").css("border", "2px solid #ff9980");
        }

        function updatePlug(newName, newPriority, newApproved, newIsOn) {
            let mac = plugs[rowInChange - 1].Mac;
            let plug = plugs[rowInChange - 1];
            if (!(newName === plug.Nickname))
                setPlugNickname(mac, newName);
            if (!(newPriority.toLowerCase() === priorityText(plug.Priority).toLowerCase()))
                setPlugPriority(mac, newPriority);
            if (!(plug.Approved === newApproved))
                approvePlug(mac);
            if (!(newIsOn === plug.IsOn)) {
                if (newIsOn)
                    turnPlugOn(mac);
                else
                    turnPlugOff(mac);
            }
        }

        function saveChanges() {
            if (inChanging) {
                let $tdName = $maniRow.children("td").eq(2);
                let $tdPriority = $maniRow.children("td").eq(3);
                let $tdApproved = $maniRow.children("td").eq(4);
                let $tdIsOn = $maniRow.children("td").eq(5);

                let newName = $tdName.children("input").eq(0).val();
                let newPriority = $tdPriority.children("select").children("option:selected").text();
                let newApproved = $tdApproved.children("input").eq(0).is(":checked") ? true : false;
                //let newApproved = $tdApproved.children("input").eq(0).attr("checked") === "checked" ? true : false;
                let newIsOn = $tdIsOn.children("div").hasClass("w3-green") ? true : false;
                //alert(newApproved);
                updatePlug(newName, newPriority, newApproved, newIsOn);

                refresh();
                //$tdName.html(newName);
                //$tdPriority.html(newPriority);
                //$tdApproved.children("input").eq(0).attr("disabled", "disabled");
                //$tdIsOn.children("div").unbind();
                $maniRow.css("backgroundColor", "");

            }
            rowInChange = -1;
            inChanging = false;
            $("tr").css("border", "");
            modify_enabled = false;
            $("tr:has(td)").on("mouseenter mouseleave");
            fadeRows();
        }

        function is() {
            if ($('#ch').is(":checked")) {
                alert("hi");
            }
        }

        function trClicked() {
            if (inChanging || !modify_enabled)
                return;
            $maniRow = $(this);
            let id = $(this).children("td").eq(0).html();
            //if (id == rowInChange)
            //    return;
            inChanging = true;
            $maniRow.css("backgroundColor", "#ff9980");
            rowInChange = id;
            editMode();
            $("tr:has(td)").off("mouseenter mouseleave");
        }

        function editMode() {
            let $tdName = $maniRow.children("td").eq(2);
            let old_name = $tdName.html();
            $tdName.empty();
            let $text = $("<input>").attr({ "type": "text", "name": "name", "value": old_name, "size": "10", "margin": "0px" });
            $tdName.append($text);

            let $tdPriority = $maniRow.children("td").eq(3);
            let old_prio = $tdPriority.html();
            $tdPriority.empty();
            let $select = $("<select>").attr({ "type": "text", "name": "name", "value": old_name });
            $tdPriority.append($select);
            $(selectArr).each(function () {
                $op = $("<option>").attr("value", this.val).text(this.text);
                if (this.text.toLowerCase() === old_prio.toLowerCase()) $op.attr("selected", "selected");
                $select.append($op);
            });

            let $tdApproved = $maniRow.children("td").eq(4);
            $tdApproved.children("input").eq(0).removeAttr("disabled");

            let $tdIsOn = $maniRow.children("td").eq(5);
            $tdIsOn.children("div").eq(0).click(function () {
                if ($(this).hasClass("w3-green"))
                    $(this).removeClass("w3-green").addClass("w3-red");
                else if ($(this).hasClass("w3-red"))
                    $(this).removeClass("w3-red").addClass("w3-green");
            })

        }

        function plugHasChanged() {
            $tbody.children("tr").css("backgroundColor", "red");
            manipulatedPlugs.add(plug[id - 1]);
        }

        
        function refresh() {
            init();
            plugs = getUser("yarden", "12345678").Plugs;     //read from server
            reloadPlugsIntoTable();
            fadeRows();
            sortByTabe();
        }

        function reloadPlugsIntoTable() {
            // init table
            $table = $("#plugs_tbl tbody");
            $table.empty();

            for (i in plugs) {
                let $tr = $("<tr>");
                let plug = plugs[i];
                
                let $td1 = $("<td>").html(++i);
                let $td2 = $("<td>").html(loadIcon(plug.Nickname));
                let $td3 = $("<td>").html(plug.Nickname);
                let $td4 = $("<td>").html(priorityText(plug.Priority));
                let $td5 = $("<td>").html(approvedText(plug.Approved));
                let $td6 = $("<td>").html(isOnText(plug.IsOn));
                let $td7 = $("<td>").html("...");
                $tr.append($td1, $td2, $td3, $td4, $td5, $td6, $td7);
                $tr.click(trClicked);
                $table.append($tr);
            }
        }

        //// in case we need to read from the server the img
        //function loadIcon2(name) {
        //    $.get("./resources/" + name + ".png", function (data, textStatus) {
        //        if (textStatus == "success") {
        //            return data;
        //        }
        //        if (textStatus == "error")
        //            return "/";
        //    })
        //}

        function loadIcon(name) {
            let $img = $("<img>").attr("src", "./resources/" + name + ".png");

            //$img.on("error", function () {
            //    $(this).remove();
            //}).attr("src", "./resources/plug.png");

            $img.on("error", function () {
                $(this).attr("src", "./resources/plug.png");
            });

            return $img;
        }

        function priorityText(priority) {
            switch (priority) {
                case 0:
                    return "ESSENTIAL";
                case 1:
                    return "NONESSENTIAL";
                case 2:
                    return "IRRELEVANT";
            }
        }

        function priorityToNumber(priority) {
            priority = priority.toUpperCase();
            switch (priority) {
                case "ESSENTIAL":
                    return 0;
                case "NONESSENTIAL":
                    return 1;
                case "IRRELEVANT":
                    return 2;
            }
        }

        function approvedText(approved) {
            let $input = $("<input>");
            $input.addClass("w3-check").attr({ type: "checkbox" }).attr("disabled", "");
            if (approved === true)
                $input.attr("checked", "checked");
            else
                $input.attr("checked", false);
            return $input;
        }

        function isOnText(isOn) {
            let color = "red";
            if (isOn)
                color = "green"
            return $("<div>").attr({ id: "circle", class: "w3-circle w3-" + color });
        }

        function sortByTabe() {
            $("th").click(function () {
                let table = $(this).parents("table").eq(0);
                var rows = table.find("tr:gt(0)").toArray().sort(comparer($(this).index()));
                this.asc = !this.asc;
                if (!this.asc) { rows = rows.reverse(); }
                for (var i = 0; i < rows.length; i++) { table.append(rows[i]); }
            })

            function comparer(index) {
                return function (a, b) {
                    var valA = getCellValue(a, index), valB = getCellValue(b, index);
                    return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB);
                }
            }
            function getCellValue(row, index) {
                let text = $(row).children('td').eq(index).text();
                //if(text === "")
                return text;
            }
        }

    </script>
</body>
</html>