<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="./styles/w3css.css" rel="stylesheet" />
    <script src="Scripts/jquery.js"></script>
    <script src="./Scripts/SmartSwitchServerInterface.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./styles/popup.css">
    <style>
        img {
            width: 50px;
            height: 50px;
        }

        #circle {
            width: 20px;
            height: 20px;
            margin: auto;
        }

        button {
            margin: 10px;
        }

        .blur {
            text-shadow: 1px 1px 5px #aaa;
            color: transparent;
        }

            .blur img, .blur div, .blur input[type=checkbox] {
                opacity: 0.3;
            }

        body {
            font-family: 'Bree Serif', serif;
            margin-top:50px;
        }

        #plugsTableContainer {
            margin-left: 100px;
            margin-right: 100px;
        }

        #plugs_tbl td, #plugs_tbl th {
            text-align: center;
            vertical-align: middle;
            padding: 8px 8px;
            /*display: table-cell;*/
            border-right: 1px solid black;
        }
    </style>

</head>
<body>
    <div id="buttonsContainer" class="w3-bar" style="width:60%;margin-left:100px">
        <button onclick="refresh()" class="w3-bar-item w3-button w3-green w3-ripple" style="width:20%">Refresh</button>
        <button onclick="modifyMode()" class="w3-bar-item w3-button w3-teal w3-ripple" style="width:20%">Edit Device</button>
        <button onclick="forTesting()" class="w3-bar-item w3-button w3-red w3-ripple" style="width:20%">For Testing</button>
        <button onclick="saveChanges()" class="w3-bar-item w3-button w3-gray w3-ripple" style="width:20%">Save</button>
    </div>

    <br />

    <div id="plugsTableContainer" class="w3-container">
        <table id="plugs_tbl" class="w3-table-all w3-hoverable">
            <thead>
                <tr class="w3-gray">
                    <th>N.</th>
                    <th>Icon</th>
                    <th>Name</th>
                    <th>Priority</th>
                    <th>Approval</th>
                    <th>IsOn</th>
                    <th>Options</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div id="test"></div>

    <script>
        function forTesting() {
            //addUser("Dudi", "1122");
            //turnPlugOn("qq:ww");
            //approvePlug("qq:ww");
            let plugs = getPlugs("yarden");
            for (i in plugs)
                $("<p>").html(plugs[i].mac + ", " + plugs[i].isOn + ", " + plugs[i].approved + "<br />").appendTo("#test");
            //alert(users);
        }

        $(document).ready(refresh());

        var manipulatedPlugs = [];
        var plugs;
        var row;
        var $maniRow;
        var rowInChange = -1;
        var inChanging = false;
        var modify_enabled = false;

        var selectArr = [
            { val: 0, text: "ESSENTIAL" },
            { val: 1, text: "NONESSENTIAL" },
            { val: 2, text: "IRRELEVANT" }
        ];

        function init() {
            rowInChange = -1;
            inChanging = false;
            modify_enabled = false;
        }

        function modifyMode() {
            modify_enabled = true;
            $("tr").css("border", "2px solid #ff9980");
        }

        function updatePlug(newName, newPriority, newApproved, newIsOn) {
            let mac = plugs[rowInChange - 1].Mac;
            let plug = plugs[rowInChange - 1];
            if (!(newName === plug.Nickname))
                setPlugNickname(mac, newName);
            if (!(newPriority.toLowerCase() === priorityText(plug.Priority).toLowerCase()))
                setPlugPriority(mac, newPriority);
            if (!(plug.Approved === newApproved))
                approvePlug(mac);
            if (!(newIsOn === plug.IsOn)) {
                if (newIsOn)
                    turnPlugOn(mac);
                else
                    turnPlugOff(mac);
            }
        }

        function saveChanges() {
            if (inChanging) {
                let $tdName = $maniRow.children("td").eq(2);
                let $tdPriority = $maniRow.children("td").eq(3);
                let $tdApproved = $maniRow.children("td").eq(4);
                let $tdIsOn = $maniRow.children("td").eq(5);

                let newName = $tdName.children("input").eq(0).val();
                let newPriority = $tdPriority.children("select").children("option:selected").text();
                let newApproved = $tdApproved.children("input").eq(0).is(":checked") ? true : false;
                //let newApproved = $tdApproved.children("input").eq(0).attr("checked") === "checked" ? true : false;
                let newIsOn = $tdIsOn.children("div").hasClass("w3-green") ? true : false;
                //alert(newApproved);
                updatePlug(newName, newPriority, newApproved, newIsOn);

                refresh();
                $maniRow.css("backgroundColor", "");

            }
            rowInChange = -1;
            inChanging = false;
            $("tr").css("border", "");
            modify_enabled = false;
            $("tr:has(td)").on("mouseenter mouseleave");
            fadeRows();
        }

        function trClicked() {
            if (inChanging || !modify_enabled)
                return;
            $maniRow = $(this);
            let id = $(this).children("td").eq(0).html();
            //if (id == rowInChange)
            //    return;
            inChanging = true;
            $maniRow.css("backgroundColor", "#ff9980");
            rowInChange = id;
            editMode();
            $("tr:has(td)").off("mouseenter mouseleave");
        }

        function editMode() {
            let $tdName = $maniRow.children("td").eq(2);
            let old_name = $tdName.html();
            $tdName.empty();
            let $text = $("<input>").attr({ "type": "text", "name": "name", "value": old_name, "size": "10", "margin": "0px" });
            $tdName.append($text);

            let $tdPriority = $maniRow.children("td").eq(3);
            let old_prio = $tdPriority.html();
            $tdPriority.empty();
            let $select = $("<select>").attr({ "type": "text", "name": "name", "value": old_name });
            $tdPriority.append($select);
            $(selectArr).each(function () {
                $op = $("<option>").attr("value", this.val).text(this.text);
                if (this.text.toLowerCase() === old_prio.toLowerCase()) $op.attr("selected", "selected");
                $select.append($op);
            });

            let $tdApproved = $maniRow.children("td").eq(4);
            $tdApproved.children("input").eq(0).removeAttr("disabled");

            let $tdIsOn = $maniRow.children("td").eq(5);
            $tdIsOn.children("div").eq(0).click(function () {
                if ($(this).hasClass("w3-green"))
                    $(this).removeClass("w3-green").addClass("w3-red");
                else if ($(this).hasClass("w3-red"))
                    $(this).removeClass("w3-red").addClass("w3-green");
            })

        }

        function plugHasChanged() {
            $tbody.children("tr").css("backgroundColor", "red");
            manipulatedPlugs.add(plug[id - 1]);
        }
        
        function refresh() {
            init();
            //plugs = getUser("yarden", "12345678").Plugs;     //read from server
            reloadPlugsIntoTable();
            fadeRows();
            sortByTabe();
        }

        function reloadPlugsIntoTable() {
            // init table
            $table = $("#plugs_tbl tbody");
            $table.empty();
            // ###################################to check#############################
            plugs = [{
                Mac: "aa:bb",
                Nickname: "TV",
                Priority: 0,
                Approved: true,
                IsOn:true
            },
                {
                    Mac: "qq:yy",
                    Nickname: "Fridge",
                    Priority: 1,
                    Approved: false,
                    IsOn: false
                }]
            // #########################################################################
            for (i in plugs) {
                let $tr = $("<tr>");
                let plug = plugs[i];
                
                let $td1 = $("<td>").html(++i);
                let $td2 = $("<td>").html(loadIcon(plug.Nickname));
                let $td3 = $("<td>").html(plug.Nickname);
                let $td4 = $("<td>").html(priorityText(plug.Priority));
                let $td5 = $("<td>").html(approvedText(plug.Approved));
                let $td6 = $("<td>").html(isOnText(plug.IsOn));
                let $td7 = $("<td>").append(moreOptionsColumn(i));

                $tr.append($td1, $td2, $td3, $td4, $td5, $td6, $td7);
                $tr.click(trClicked);
                $table.append($tr);
            }
        }

        function moreOptionsColumn(rowIndex) {
            var $div = $("<div>", { text: "..." }).addClass("popup").on("click", function () {
                $("#myPopup" + (rowIndex)).toggleClass("show");
            })
            let $span = $("<span>", { class: "popuptext", id: "myPopup" + (rowIndex) }).appendTo($div);
            let pages = ["device_Timing_Summary.html", "showPowerConsumption.html", "device_settings.html"];
            let btnNames = ["Timing Settings", "Power Usage", "Settings"];
            let plug = plugs[rowIndex - 1];
            for (let i = 1; i < 4; i++) {
                $("<input>", {
                    type: "button", class: "btn" + i + " w3-button w3-teal w3-ripple" , value: btnNames[i-1], style: "display:inline-block;margin:3px;"
                }).appendTo($span).on("click", function () {
                    if (plug.Mac)
                        window.parent.$("#mainFrame").attr("src", "./" + pages[i-1] + "?mac=" + plug.Mac);
                });
            }
            return $div;
        }

        function loadIcon(name) {
            let $img = $("<img>").attr("src", "./resources/" + name + ".png");

            //$img.on("error", function () {
            //    $(this).remove();
            //}).attr("src", "./resources/plug.png");

            $img.on("error", function () {
                $(this).attr("src", "./resources/plug.png");
            });

            return $img;
        }

        function priorityText(priority) {
            switch (priority) {
                case 0:
                    return "ESSENTIAL";
                case 1:
                    return "NONESSENTIAL";
                case 2:
                    return "IRRELEVANT";
            }
        }

        function priorityToNumber(priority) {
            priority = priority.toUpperCase();
            switch (priority) {
                case "ESSENTIAL":
                    return 0;
                case "NONESSENTIAL":
                    return 1;
                case "IRRELEVANT":
                    return 2;
            }
        }

        function approvedText(approved) {
            let $input = $("<input>");
            $input.addClass("w3-check").attr({ type: "checkbox" }).attr("disabled", "");
            if (approved === true)
                $input.attr("checked", "checked");
            else
                $input.attr("checked", false);
            return $input;
        }

        function isOnText(isOn) {
            let color = "red";
            if (isOn)
                color = "green"
            return $("<div>").attr({ id: "circle", class: "w3-circle w3-" + color });
        }

        // sort 
        function sortByTabe() {
            $("th").click(function () {
                let table = $(this).parents("table").eq(0);
                var rows = table.find("tr:gt(0)").toArray().sort(comparer($(this).index()));
                this.asc = !this.asc;
                if (!this.asc) { rows = rows.reverse(); }
                for (var i = 0; i < rows.length; i++) { table.append(rows[i]); }
            })

            function comparer(index) {
                return function (a, b) {
                    var valA = getCellValue(a, index), valB = getCellValue(b, index);
                    return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB);
                }
            }
            function getCellValue(row, index) {
                let text = $(row).children('td').eq(index).text();
                //if(text === "")
                return text;
            }
        }

        // style function fading rows on hover
        function fadeRows() {
            $("tr:has(td)").hover(function (e) {
                $(this).css("cursor", "pointer");
                $("tr:has(td)").addClass('blur');
                $(this).removeClass('blur');
            },
                function (e) {
                    if (!modify_enabled)
                        $("tr:has(td)").removeClass('blur');
                });

            $("img").hover(function (e) {
                $(this).css("cursor", "pointer");
                $("img").addClass('blur');
                $(this).removeClass('blur');
            },
                function (e) {
                    if (!modify_enabled)
                        $("img").removeClass('blur');
                });
        }


    </script>
    <script>
        ////////////////////////////need to check
        if (sessionStorage.currentSmartSwitchUser) {
            refresh();
        }
    </script>
</body>
</html>