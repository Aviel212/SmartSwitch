<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="styles/w3css.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="scripts/jquery.js"></script>
    <script src="scripts/SmartSwitchJavaScriptAPI.js"></script>
</head>
<body>
    <div id="main-div">
        <table id="main-table">
            <tr>
                <td><h4><u>Add New Device:   </u></h4></td>
                <td>
                    <a id="reloader" href="AddNewDevice.html">
                        <i class="fa fa-refresh"></i>
                    </a>
                </td>

            </tr>
        </table>
        
        <div id="myPopUp-div" style="display:none">
            <table>
                <tr>
                    <td><p>nickname</p></td>
                    <td><input type="text" id="Nickname"></td>
                </tr>
                <tr>
                    <td><p>priority:</p></td>
                    <td>
                        <input type="radio" name="prio" value="Essential">Essential<br>
                        <input type="radio" name="prio" value="Nonessential">Nonessential<br>
                    </td>
                </tr>
            </table>
            <input type="button" id="answeryes" value="next" onclick="approveContent()" />
            <input type="button" id="answerno" value="cancel" onclick="cancelPopUp()" />

        </div>
    </div>
    <script>
        let myPlugs;
        let $myPopUp;
        let $main;
        let $notifier;
        let $rowToDelete;
        let locationHref = $('#reloader').attr("href");

        $(document).ready(function () {
            
      
            let username = sessionStorage.currentSmartSwitchUser; //"avi";
            let $loadingGif = $("<img>").prop({
                'src': 'images/loadingGif.gif',
                'width': parseInt($("#main-div").css("width")) / 25
            });
            $("#main-div").append($loadingGif);
            getUserPlugs(username, function (plugs) {
                $loadingGif.remove();
                myPlugs = plugs;
                $main = $("#main-div");
                $main.css("position", "relative");
                $myPopUp = $("#myPopUp-div");

                $myPopUp.css("z-index", "2000");
                $myPopUp.css('border', '3px solid black');
                $myPopUp.css("background-color", "yellow");
                $myPopUp.css({ top: 40, left: 50, position: 'absolute' });
                $myPopUp.hide();

                //getting all available mac addresses and appending them to main div
                drawMacAddress();

            })
           
            
        });

        function drawMacAddress() {
            for (let i = 0; i < myPlugs.length; i++) {
                if (myPlugs[i].approved == false) {
                    
                    insertnotApproved(myPlugs[i]);
                }

            }


        }
        function insertnotApproved(currentPlug) {
            let $currentTR = $("<tr>");
            let $dateTD = $("<td>");
            let $buttonsTD = $("<td>");

            let $dateText = $("<p>");

            $dateText.text(formatDate(currentPlug.addedAt));//gets the date for the current plug
            $dateTD.append($dateText);

            let $accept = $("<input>").prop({ "type": "button", "value": "accept" });
            let $reject = $("<input>").prop({ "type": "button", "value": "reject" });

            $accept.prop("value", "accept");
            $reject.prop("value", "reject");

            $accept.addClass('w3-button');
            $accept.addClass('w3-blue');
            $accept.addClass('w3-round');

            $reject.addClass('w3-button');
            $reject.addClass('w3-red');
            $reject.addClass('w3-round');

            $accept.on('click', function (e) {//my pop up shows up to let user enter nickname and priority
                $myPopUp.css({ top: 40, left: 50, position: 'absolute' });//top and left will need to be discussed
          
                $("input[type='button']").prop("disabled", true); //disable all buttons
                $("#myPopUp-div input[type='button']").prop("disabled", false);//leave the buttons in the hidden div working
                $notifier = currentPlug//copying the current chosen mac address
                $rowToDelete = $currentTR;
                
                $("#reloader").removeAttr('href');

              
                let offset = $main.offset();
                let y = e.pageY - offset.top;
                $myPopUp.css('top', y + 'px');              
                $myPopUp.show();
           
            });
            $reject.on('click', function () {
                denyPlug(currentPlug.mac, function () {
                    $currentTR.remove();
                })

            });

            let $buttonTable = $("<table>");//creating a place for the buttons
            let $buttonTR = $("<tr>");
            let $Atd = $("<td>");
            let $Btd = $("<td>");
            $Atd.append($accept);
            $Btd.append($reject);
            $buttonTR.append($Atd);
            $buttonTR.append($Btd);
            $buttonTable.append($buttonTR);

            $buttonsTD.append($buttonTable);

            $currentTR.append($dateTD);
            $currentTR.append($buttonsTD);
            $("#main-table").append($currentTR);


        }
        function formatDate(date) {
            let month = (date.getMonth() + 1) <= 9 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1;
            let day = date.getDay() <= 9 ? '0' + date.getDay() : date.getDay();
            let hour = date.getHours() <= 9 ? '0' + date.getHours() : date.getHours();
            let minute = date.getMinutes() <= 9 ? '0' + date.getMinutes() : date.getMinutes();
            return day + '/' + month + '/' + date.getFullYear() + ' ' + hour + ':' + minute;
        }



        function cancelPopUp() {
            $myPopUp.hide();
            $("input[type='button']").prop("disabled", false);

            $("#reloader").attr("href", locationHref);


        }
        function approveContent() {
            $myPopUp.hide();
            $("input[type='button']").prop("disabled", false);
            $rowToDelete.remove();

            $("#reloader").attr("href", locationHref);


            approvePlug($notifier.mac, function () {
                $notifier.Approved = true;
            });

            let priorityString = $("input[name='prio']:checked").val();
            let priorityToSend;
            if (priorityString === "Essential") priorityToSend = Priorities.Essential;
            else priorityToSend = Priorities.Nonessential;

            let plugProperties = {
                "mac": $notifier.mac,
                "nickname": $("#Nickname").val(),
                "priority": priorityToSend
            };


            updatePlug(plugProperties, function () {
                $notifier.nickname = $("#Nickname").val();
                $notifier.priority = $("input[name='prio']:checked").val();
            })
                       
           
        }





    </script>
</body>
</html>